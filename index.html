<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è»½éŸ³EQãƒ˜ãƒ«ãƒ‘ãƒ¼å›(Beta ver.)</title>
  <style>
    /* -----------------------------------------
        ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šï¼ˆCSSï¼‰
    ----------------------------------------- */
    body { font-family: sans-serif; background:#111; color:white; margin: 0; padding: 10px; padding-bottom: 50px; }
    .row { display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333; align-items:center; transition: background 0.2s; }
    
    .highlight-band { background: #ff3b30 !important; color: white; }
    
    select, input { background:#222; color:white; padding:4px; font-size:16px; border-radius: 4px; border: 1px solid #444; }
    h2, h3 { text-align:center; margin-bottom: 10px; }
    button { margin:4px; padding:8px 12px; font-size:13px; cursor: pointer; border-radius: 4px; border: none; background: #444; color: white; }
    button:active { background: #666; }
    .section { margin-top:20px; border: 1px solid #333; padding: 10px; border-radius: 8px; }
    .cut { color:#4da6ff; font-weight:bold; margin-bottom: 5px; }
    .status { font-size:12px; margin-left:6px; color:#00ff99; }
    .editor { text-align:center; margin-bottom: 20px; background: #222; padding: 15px; border-radius: 8px; }
    .band-op { display: flex; justify-content: center; gap: 8px; margin-top: 10px; flex-wrap: wrap; }

    #analyzerSection { background: #000; padding: 15px; border-radius: 8px; }
    .analyzer-main { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .canvas-container { position: relative; width: 100%; }
    canvas { width: 100%; height: 180px; background: #000; border-bottom: 2px solid #444; display: block; }
    
    .history-box { width: 100%; background: #1a1a1a; padding: 10px; border-radius: 4px; border: 1px solid #333; font-size: 13px; box-sizing: border-box; }
    .history-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #222; }
    .history-title { font-weight: bold; text-align: center; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px; }
    .hist-red { color: #ff3b30; }
    .hist-yellow { color: #ffeb3b; }

    .detect-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .detect-box { background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444; text-align: center; }
    .detect-label { font-size: 11px; color: #aaa; margin-bottom: 5px; }
    .detect-value { font-size: 20px; color: #ffeb3b; font-weight: bold; }

    .detect-btn { background: #007AFF; padding: 15px; width: 100%; font-size: 16px; font-weight: bold; margin-top: 10px; }
    .detect-btn.active { background: #ff3b30; }

    .warning-note { font-size: 12px; color: #aaa; margin-top: 20px; text-align: center; line-height: 1.6; }
    .autosave-msg { font-size: 11px; color: #00ff99; margin-top: 5px; height: 14px; }
    .prompt-msg { font-size: 12px; color: #ffeb3b; margin: 10px 0; display: block; }

    @media (min-width: 600px) {
      .analyzer-main { flex-direction: row; }
      .history-box { width: 180px; }
    }
  </style>
</head>
<body>

<h2>è»½éŸ³EQãƒ˜ãƒ«ãƒ‘ãƒ¼å›(Beta ver.)</h2>

<div class="editor">
  <h3>â–¼ æ¥½å™¨ã®é¸æŠ</h3>
  <div id="instrumentButtons"></div>
  <span class="prompt-msg">â€» æœ€åˆã«æ¥½å™¨ã®ã€Œèª­è¾¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€30ç§’ã”ã¨ã®è‡ªå‹•ä¿å­˜ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚</span>
  <div id="autosaveStatus" class="autosave-msg"></div>
  <br>
  <button onclick="resetEditOnly()" style="background: #622;">ç¾åœ¨ã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div class="section">
  <h3>â–¼ ã‚«ãƒƒãƒˆä¸­ã®å¸¯åŸŸ</h3>
  <div id="cutList"></div>
</div>

<div class="section">
  <h3>â–¼ EQãƒ¡ãƒ¢</h3>
  <div class="band-op">
    <input type="text" id="bandInput" placeholder="å‘¨æ³¢æ•°(ä¾‹: 800)">
    <button onclick="addBand()" style="background: #2a4;">å¸¯åŸŸã‚’è¿½åŠ </button>
    <button onclick="removeBand()" style="background: #a22;">å¸¯åŸŸã‚’å‰Šé™¤</button>
  </div>
  <p style="font-size: 10px; text-align: center; color: #888; margin-top: 8px;">â€»20Hzã€œ20kHzã€‚1kç­‰ã®è¡¨è¨˜ã‚‚OKï¼</p>
  <div id="eq" style="margin-top: 15px;"></div>
</div>

<div class="section" id="analyzerSection">
  <h3>â–¼ ãƒã‚¦ãƒªãƒ³ã‚°æ¤œçŸ¥</h3>
  <div class="detect-grid">
    <div class="detect-box">
      <div class="detect-label">ãƒ”ãƒ¼ã‚¯å‘¨æ³¢æ•°</div>
      <div id="peakFreq" class="detect-value">--- Hz</div>
    </div>
    <div class="detect-box">
      <div class="detect-label">è¿‘ä¼¼å¸¯åŸŸ</div>
      <div id="targetBand" class="detect-value">--- Hz</div>
    </div>
  </div>

  <div class="analyzer-main">
    <div class="canvas-container">
      <canvas id="visualizer"></canvas>
      <div id="canvasLabels" style="position:relative; height: 70px; font-size: 10px; color: #aaa; margin-top: 5px; border-top: 1px solid #333;"></div>
    </div>
    <div class="history-box">
      <div class="history-title hist-red">ğŸš¨ èµ¤(é »å‡º)</div>
      <div id="historyListRed"></div>
      <div class="history-title hist-yellow" style="margin-top:10px;">âš ï¸ é»„(é »å‡º)</div>
      <div id="historyListYellow"></div>
    </div>
  </div>

  <div class="band-op" style="margin-top: 20px; background: #1a1a1a; padding: 10px; border-radius: 8px;">
    <div style="width: 100%; font-size: 13px; margin-bottom: 5px; color: #ffeb3b;">â–¼ æ¤œçŸ¥ç”¨ã‚¬ã‚¤ãƒ‰å¸¯åŸŸã®ç·¨é›†</div>
    <input type="text" id="guideBandInput" placeholder="å‘¨æ³¢æ•°(ä¾‹: 1.5k)">
    <button onclick="addGuideBand()" style="background: #2a4;">ã‚¬ã‚¤ãƒ‰ã‚’è¿½åŠ </button>
    <button onclick="removeGuideBand()" style="background: #a22;">ã‚¬ã‚¤ãƒ‰ã‚’å‰Šé™¤</button>
  </div>
  
  <button id="detectBtn" class="detect-btn">æ¤œçŸ¥ã‚’é–‹å§‹</button>
</div>

<div class="warning-note">
  ã“ã®ãƒã‚¦ãƒªãƒ³ã‚°æ¤œçŸ¥æ©Ÿèƒ½ã¯ã€ãƒã‚¤ã‚¯ã®æ€§èƒ½ã‚„å‘¨å›²ã®é¨’éŸ³ã€åéŸ¿ã«ã‚ˆã£ã¦èª¤å·®ãŒç”Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
  ã‚ãã¾ã§è£œåŠ©çš„ãªç›®å®‰ã¨ã—ã¦åˆ©ç”¨ã—ã€æœ€çµ‚çš„ãªèª¿æ•´ã¯å¿…ãšè‡ªåˆ†è‡ªèº«ã®è€³ã§è´ã„ã¦ã€éŸ³ã®é•å’Œæ„Ÿã‚„éŸ³è³ªã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã­ã€‚
</div>

<script>
/* -----------------------------------------
    ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»åˆæœŸè¨­å®š
----------------------------------------- */
const instruments = ["vocal", "drum", "bass", "guitar"];
let bands = ["80","100","125","160","200","250","315","400","500","630","800","1k","1.25k","1.6k","2k","2.5k","3.15k","4k","5k","6.3k","8k"];
// ã‚¬ã‚¤ãƒ‰å¸¯åŸŸç”¨ã®ç‹¬ç«‹ã—ãŸãƒªã‚¹ãƒˆ
let guideBands = ["80","100","125","160","200","250","315","400","500","630","800","1k","1.25k","1.6k","2k","2.5k","3.15k","4k","5k","6.3k","8k"];
const options = [{value: 0, label:"ãƒ•ãƒ©ãƒƒãƒˆ"},{value:-3, label:"1åˆ‡ã‚Š"},{value:-6, label:"2åˆ‡ã‚Š"},{value:-9, label:"3åˆ‡ã‚Š"}];

let eq = {};
let audioCtx = null, currentOsc = null, currentGain = null, stopTimer = null;
let analyser = null, isAnalysing = false, historyData = [];
let currentInstrument = null; 

const canvas = document.getElementById('visualizer');
const ctx = canvas.getContext('2d');
const peakDisplay = document.getElementById('peakFreq');
const targetDisplay = document.getElementById('targetBand');
const detectBtn = document.getElementById('detectBtn');
const historyListRedDiv = document.getElementById('historyListRed');
const historyListYellowDiv = document.getElementById('historyListYellow');

function parseFreq(str) {
  if (typeof str !== 'string') return parseFloat(str);
  let val = str.toLowerCase();
  if (val.includes("k")) return parseFloat(val.replace("k", "")) * 1000;
  return parseFloat(val);
}

function formatFreqLabel(num) {
  if (num >= 1000) return (Math.round(num / 100) / 10) + "k";
  return Math.round(num).toString();
}

function init() {
  const container = document.getElementById("instrumentButtons");
  instruments.forEach(inst => {
    const div = document.createElement("div");
    div.style.marginBottom = "8px";
    div.innerHTML = `
      <button onclick="load('${inst}')"><strong>${inst.toUpperCase()}</strong> èª­è¾¼</button> 
      <button onclick="save('${inst}')">ä¿å­˜</button> 
      <button onclick="resetWithSave('${inst}')">å‰Šé™¤</button> 
      <span id="status_${inst}" class="status"></span>
    `;
    container.appendChild(div);
  });
  bands.forEach(b => eq[b] = 0);
  updateStatus();
  render();
  setInterval(autoSave, 30000);
}

function playTone(label) {
  const freq = parseFreq(label);
  if (isNaN(freq) || freq < 250 || freq > 2500) return;
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  stopTone();
  currentOsc = audioCtx.createOscillator();
  currentGain = audioCtx.createGain();
  currentOsc.type = "sine";
  currentOsc.frequency.value = freq;
  currentGain.gain.value = 0.05;
  currentOsc.connect(currentGain);
  currentGain.connect(audioCtx.destination);
  currentOsc.start();
  stopTimer = setTimeout(stopTone, 800);
}

function stopTone() {
  if (currentOsc) { try { currentOsc.stop(); } catch(e){} currentOsc.disconnect(); currentOsc = null; }
  if (stopTimer) clearTimeout(stopTimer);
}

detectBtn.onclick = async () => {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  if (isAnalysing) {
    isAnalysing = false;
    detectBtn.textContent = "æ¤œçŸ¥ã‚’é–‹å§‹";
    detectBtn.classList.remove('active');
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;
    analyser.smoothingTimeConstant = 0.4;
    source.connect(analyser);
    isAnalysing = true;
    detectBtn.textContent = "æ¤œçŸ¥ã‚’åœæ­¢";
    detectBtn.classList.add('active');
    draw();
  } catch (err) { alert("ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚"); }
};

function draw() {
  if (!isAnalysing) return;
  requestAnimationFrame(draw);

  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  analyser.getByteFrequencyData(dataArray);

  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  let maxVal = 0, maxIndex = -1, sum = 0;
  const logBase = Math.log10(bufferLength);

  for (let i = 0; i < bufferLength; i++) {
    const val = dataArray[i];
    sum += val;
    if (val > maxVal) { maxVal = val; maxIndex = i; }
    
    let x = (Math.log10(i + 1) / logBase) * canvas.width;
    let nextX = (Math.log10(i + 2) / logBase) * canvas.width;
    let w = nextX - x;
    const barHeight = (val / 255) * canvas.height;

    if (val > 240) {
      ctx.fillStyle = '#ff3b30'; 
    } else if (val > 200) {
      ctx.fillStyle = '#ffeb3b'; 
    } else {
      ctx.fillStyle = '#00ff99'; 
    }
    ctx.fillRect(x, canvas.height - barHeight, w + 1, barHeight);
  }

  const average = sum / bufferLength;

  if (maxVal > 200 && maxVal > average + 85) {
    const level = maxVal > 240 ? 'red' : 'yellow';
    const rawFreq = Math.round(maxIndex * audioCtx.sampleRate / analyser.fftSize);
    peakDisplay.textContent = formatFreqLabel(rawFreq) + " Hz";
    findNearest(rawFreq, level);
  } else {
    if(Math.random() > 0.9) clearHighlights();
  }
  updateHistory();
}

function findNearest(detectedFreq, level) {
  let nearestLabel = null;
  let minDiff = Infinity;
  // ã‚¬ã‚¤ãƒ‰ç”¨ã®å¸¯åŸŸãƒªã‚¹ãƒˆã‹ã‚‰æœ€ã‚‚è¿‘ã„ã‚‚ã®ã‚’æ¢ã™
  guideBands.forEach(b => {
    const f = parseFreq(b);
    const diff = Math.abs(f - detectedFreq);
    if (diff < minDiff && diff < f * 0.10) { minDiff = diff; nearestLabel = b; }
  });

  if (nearestLabel) {
    targetDisplay.textContent = nearestLabel + " Hz";
    if (historyData.length === 0 || Date.now() - historyData[historyData.length-1].time > 800) {
      historyData.push({ time: Date.now(), band: nearestLabel, level: level });
    }
    // èµ¤è‰²æ¤œçŸ¥æ™‚ã«EQè¨­å®šè¡Œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆEQãƒªã‚¹ãƒˆã«å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
    if (level === 'red') {
        document.querySelectorAll('.row').forEach(row => {
          if (row.querySelector('strong').innerText === nearestLabel + "Hz") row.classList.add('highlight-band');
          else row.classList.remove('highlight-band');
        });
    }
  }
}

function updateHistory() {
  const now = Date.now();
  historyData = historyData.filter(h => now - h.time < 60000);
  
  const countsRed = {};
  const countsYellow = {};
  
  historyData.forEach(h => {
    if (h.level === 'red') countsRed[h.band] = (countsRed[h.band] || 0) + 1;
    else countsYellow[h.band] = (countsYellow[h.band] || 0) + 1;
  });

  const sortedRed = Object.keys(countsRed).sort((a, b) => countsRed[b] - countsRed[a]);
  const sortedYellow = Object.keys(countsYellow).sort((a, b) => countsYellow[b] - countsYellow[a]);

  historyListRedDiv.innerHTML = sortedRed.slice(0, 3).map(band => `
    <div class="history-item"><span>${band}Hz</span><span>${countsRed[band]}å›</span></div>
  `).join('');

  historyListYellowDiv.innerHTML = sortedYellow.slice(0, 3).map(band => `
    <div class="history-item"><span>${band}Hz</span><span>${countsYellow[band]}å›</span></div>
  `).join('');
}

function clearHighlights() {
  document.querySelectorAll('.row').forEach(row => row.classList.remove('highlight-band'));
}

function render() {
  // ãƒªã‚¹ãƒˆã®ã‚½ãƒ¼ãƒˆ
  bands.sort((a,b) => parseFreq(a) - parseFreq(b));
  guideBands.sort((a,b) => parseFreq(a) - parseFreq(b));

  const container = document.getElementById("eq");
  const cutContainer = document.getElementById("cutList");
  const labelContainer = document.getElementById("canvasLabels");
  
  container.innerHTML = "";
  cutContainer.innerHTML = "";
  labelContainer.innerHTML = "";

  // 1. EQãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æç”»
  bands.forEach((b) => {
    const f = parseFreq(b);
    if (eq[b] < 0) {
      const opt = options.find(o => o.value == eq[b]);
      cutContainer.innerHTML += `<div class="cut">${b}Hz : ${opt.label}</div>`;
    }
    const row = document.createElement("div");
    row.className = "row";
    const toneBtn = (f >= 250 && f <= 2500) ? `<button onclick="playTone('${b}')">è©¦è´</button>` : `<div style="width:50px"></div>`;
    let selectHTML = `<select onchange="change('${b}', this.value)">`;
    options.forEach(o => { selectHTML += `<option value="${o.value}" ${eq[b] == o.value ? "selected" : ""}>${o.label}</option>`; });
    selectHTML += `</select>`;
    row.innerHTML = `<span><strong>${b}Hz</strong></span> ${toneBtn} ${selectHTML}`;
    container.appendChild(row);
  });

  // 2. ã‚°ãƒ©ãƒ•ä¸‹ã®ã‚¬ã‚¤ãƒ‰ãƒ©ãƒ™ãƒ«æç”» (guideBandsã‚’ä½¿ç”¨)
  const logBase = Math.log10(2048);
  guideBands.forEach((b) => {
    const f = parseFreq(b);
    const index = (f * 2048) / 22050; // å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«è¿‘ä¼¼
    const xPos = (Math.log10(index + 1) / logBase) * 100;

    if (xPos >= 0 && xPos <= 100) {
      const l = document.createElement("div");
      l.style.position = "absolute";
      l.style.left = xPos + "%";
      l.style.transform = "translateX(-50%) rotate(90deg)"; // å®Œå…¨ã«ç¸¦
      l.style.transformOrigin = "top center";
      l.style.whiteSpace = "nowrap";
      l.style.paddingTop = "12px";
      l.innerText = b;
      labelContainer.appendChild(l);
    }
  });
}

// EQç”¨
function addBand() {
  const input = document.getElementById("bandInput").value.trim();
  if(!input) return;
  const fVal = parseFreq(input);
  if (isNaN(fVal) || fVal < 20 || fVal > 20000 || bands.includes(input)) {
    alert("æ­£ã—ã„å‘¨æ³¢æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  bands.push(input);
  eq[input] = 0;
  document.getElementById("bandInput").value = "";
  render();
}

function removeBand() {
  const input = document.getElementById("bandInput").value.trim();
  const index = bands.indexOf(input);
  if(index === -1) {
    alert("å¸¯åŸŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  bands.splice(index, 1);
  delete eq[input];
  document.getElementById("bandInput").value = "";
  render();
}

// æ¤œçŸ¥ã‚¬ã‚¤ãƒ‰ç”¨
function addGuideBand() {
  const input = document.getElementById("guideBandInput").value.trim();
  if(!input) return;
  const fVal = parseFreq(input);
  if (isNaN(fVal) || fVal < 20 || fVal > 20000 || guideBands.includes(input)) {
    alert("æ­£ã—ã„å‘¨æ³¢æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  guideBands.push(input);
  document.getElementById("guideBandInput").value = "";
  render();
}

function removeGuideBand() {
  const input = document.getElementById("guideBandInput").value.trim();
  const index = guideBands.indexOf(input);
  if(index === -1) {
    alert("å¸¯åŸŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  guideBands.splice(index, 1);
  document.getElementById("guideBandInput").value = "";
  render();
}

function change(b, value) { eq[b] = parseInt(value); render(); }

function save(type) { 
  localStorage.setItem("eq_" + type, JSON.stringify(eq)); 
  updateStatus(); 
  alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ"); 
}

function load(type) {
  const data = localStorage.getItem("eq_" + type);
  if (data) { 
    eq = JSON.parse(data); 
    bands = Object.keys(eq); 
  } else { 
    bands = ["80","100","125","160","200","250","315","400","500","630","800","1k","1.25k","1.6k","2k","2.5k","3.15k","4k","5k","6.3k","8k"];
    eq = {};
    bands.forEach(b => eq[b] = 0);
  }
  currentInstrument = type; 
  render();
  updateAutosaveMsg();
}

function autoSave() {
  if (currentInstrument) {
    localStorage.setItem("eq_" + currentInstrument, JSON.stringify(eq));
    const msg = document.getElementById("autosaveStatus");
    const now = new Date();
    msg.innerText = "ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–å®Œäº† (" + currentInstrument.toUpperCase() + ") " + now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    setTimeout(() => { msg.innerText = ""; }, 3000);
    updateStatus();
  }
}

function updateAutosaveMsg() {
    const msg = document.getElementById("autosaveStatus");
    if (currentInstrument) msg.innerText = "ç¾åœ¨ " + currentInstrument.toUpperCase() + " ã‚’ç·¨é›†ä¸­ï¼ˆ30ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜ä¸­ï¼‰";
}

function resetEditOnly() { bands.forEach(b => eq[b]=0); render(); }
function resetWithSave(type) { 
  if(confirm("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
    localStorage.removeItem("eq_" + type); 
    if (currentInstrument === type) currentInstrument = null;
    updateStatus(); 
    document.getElementById("autosaveStatus").innerText = "";
  } 
}
function updateStatus() { instruments.forEach(t => { 
  const targetStatus = document.getElementById("status_" + t);
  if(targetStatus) targetStatus.innerText = localStorage.getItem("eq_" + t) ? "â—ä¿å­˜æ¸ˆ" : ""; 
}); }

init();
</script>
</body>
</html>

